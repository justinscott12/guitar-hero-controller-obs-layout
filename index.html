<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Guitar Overlay</title>
  <link rel="stylesheet" href="guitar.css">
  <style>
    * { margin: 0; padding: 0; }
    html, body { background: transparent; overflow: hidden; }
    #ws-dot { position: fixed; bottom: 8px; right: 8px; width: 16px; height: 16px; border-radius: 50%; background: #666; border: 2px solid rgba(255,255,255,0.5); }
    #ws-dot.connected { background: #0c0; }
  </style>
</head>
<body>
  <div id="ws-dot" title="WebSocket: gray=disconnected, green=connected (keys work when unfocused)"></div>
  <div class="guitar-overlay">
    <div class="fret fret-green" data-keycode="47"></div>
    <div class="fret fret-red" data-keycode="46"></div>
    <div class="fret fret-yellow" data-keycode="45"></div>
    <div class="fret fret-blue" data-keycode="44"></div>
    <div class="fret fret-orange" data-keycode="42,54"></div>
  </div>

  <script>
    const keyToFret = { 47: 'green', 46: 'red', 45: 'yellow', 44: 'blue', 42: 'orange', 54: 'orange' };
    const keyNameToFret = { 'v': 'green', 'c': 'red', 'x': 'yellow', 'z': 'blue', 'shift': 'orange' };

    function setPressedByName(name, pressed) {
      const el = document.querySelector('.fret-' + name);
      if (el) el.classList.toggle('pressed', pressed);
    }

    function setPressed(keycode, pressed) {
      const k = typeof keycode === 'string' ? parseInt(keycode, 10) : keycode;
      const name = keyToFret[k];
      if (name) setPressedByName(name, pressed);
    }

    document.addEventListener('keydown', function(e) {
      const k = e.key.toLowerCase();
      if (keyNameToFret[k]) { setPressedByName(keyNameToFret[k], true); e.preventDefault(); }
      else if (e.key === 'Shift') setPressedByName('orange', true);
    });
    document.addEventListener('keyup', function(e) {
      const k = e.key.toLowerCase();
      if (keyNameToFret[k]) { setPressedByName(keyNameToFret[k], false); e.preventDefault(); }
      else if (e.key === 'Shift') setPressedByName('orange', false);
    });

    function onMessage(e) {
      try {
        const d = JSON.parse(e.data);
        if (d.event_type === 'key_pressed') setPressed(d.keycode, true);
        else if (d.event_type === 'key_released') setPressed(d.keycode, false);
      } catch (_) {}
    }

    const dot = document.getElementById('ws-dot');
    const ws = new WebSocket('ws://127.0.0.1:16899/');
    ws.onopen = () => dot.classList.add('connected');
    ws.onclose = () => { dot.classList.remove('connected'); setTimeout(() => location.reload(), 3000); };
    ws.onmessage = onMessage;
  </script>
</body>
</html>
