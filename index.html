<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Guitar Overlay</title>
  <link rel="stylesheet" href="guitar.css">
  <style>
    * { margin: 0; padding: 0; }
    html, body { background: transparent; overflow: hidden; }
    #ws-dot { position: fixed; bottom: 8px; right: 8px; width: 16px; height: 16px; border-radius: 50%; background: #666; border: 2px solid rgba(255,255,255,0.5); }
    #ws-dot.connected { background: #0c0; }
  </style>
</head>
<body>
  <div id="ws-dot" title="WebSocket: gray=disconnected, green=connected (keys work when unfocused)"></div>
  <div id="guitar-wrap" style="position:relative;width:741px;height:250px;background:url('Guitar.png') no-repeat 0 0;background-size:741px 250px;">
    <svg id="guitar-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 741 250" width="741" height="250" style="position:absolute;left:0;top:0;pointer-events:none;">
      <defs>
        <style>
          .fret-fill { fill: none; transition: fill 0.08s ease-out; }
          .fret-fill.pressed { fill: currentColor; }
          .fret-orange { color: #fd8b00; }
          .fret-yellow { color: #ffcc00; }
          .fret-blue { color: #0066ff; }
          .fret-red { color: #ff3333; }
          .fret-green { color: #33cc33; }
        </style>
      </defs>
      <g id="fret-container"></g>
    </svg>
  </div>

  <script>
    // === FRET TUNING - edit these variables only ===
    const FRET = {
      width: 18,                                     // total width of each fill
      top: 112,                                      // top y coordinate
      get bottom() { return this.top + 24; },        // bottom of sides (before curve)
      get curveBottom() { return this.bottom + 6; }, // lowest point of curve
      startX: 510,                                   // center x of leftmost fret (orange)
      spacing: 24.5                                  // horizontal gap between fret centers
    };

    const FRET_ORDER = ['orange', 'blue', 'yellow', 'red', 'green'];

    (function initFrets() {
      const container = document.getElementById('fret-container');
      const halfW = FRET.width / 2;
      FRET_ORDER.forEach(function(name, i) {
        const cx = FRET.startX + i * FRET.spacing;
        const left = cx - halfW, right = cx + halfW;
        const d = 'M ' + left + ' ' + FRET.top + ' L ' + left + ' ' + FRET.bottom + ' Q ' + cx + ' ' + FRET.curveBottom + ' ' + right + ' ' + FRET.bottom + ' L ' + right + ' ' + FRET.top + ' Z';
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('class', 'fret fret-' + name + ' fret-fill');
        path.setAttribute('id', 'fret-' + name);
        path.setAttribute('d', d);
        container.appendChild(path);
      });
    })();

    // Prevent OBS/CEF from throttling this page when the Interact window is closed
    if ('locks' in navigator) {
      navigator.locks.request('keep-awake', { mode: 'shared' }, function() {
        return new Promise(function() {});
      });
    }

    const keyToFret = { 47: 'green', 46: 'red', 45: 'yellow', 44: 'blue', 42: 'orange', 54: 'orange' };
    const keyNameToFret = { 'v': 'green', 'c': 'red', 'x': 'yellow', 'z': 'blue', 'shift': 'orange' };

    function setPressedByName(name, pressed) {
      const el = document.getElementById('fret-' + name);
      if (el) el.classList.toggle('pressed', pressed);
    }

    function setPressed(keycode, pressed) {
      const k = typeof keycode === 'string' ? parseInt(keycode, 10) : keycode;
      const name = keyToFret[k];
      if (name) setPressedByName(name, pressed);
    }

    document.addEventListener('keydown', function(e) {
      const k = e.key.toLowerCase();
      if (keyNameToFret[k]) { setPressedByName(keyNameToFret[k], true); e.preventDefault(); }
      else if (e.key === 'Shift') setPressedByName('orange', true);
    });
    document.addEventListener('keyup', function(e) {
      const k = e.key.toLowerCase();
      if (keyNameToFret[k]) { setPressedByName(keyNameToFret[k], false); e.preventDefault(); }
      else if (e.key === 'Shift') setPressedByName('orange', false);
    });

    function onMessage(e) {
      try {
        const d = JSON.parse(e.data);
        if (d.event_type === 'key_pressed') setPressed(d.keycode, true);
        else if (d.event_type === 'key_released') setPressed(d.keycode, false);
        document.body.offsetHeight; // force repaint so OBS shows updates when unfocused
      } catch (_) {}
    }

    const dot = document.getElementById('ws-dot');
    const ws = new WebSocket('ws://127.0.0.1:16899/');
    ws.onopen = () => dot.classList.add('connected');
    ws.onclose = () => { dot.classList.remove('connected'); setTimeout(() => location.reload(), 3000); };
    ws.onmessage = onMessage;
  </script>
</body>
</html>
